<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>IMAP Bounce Processor - Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .task-buttons {
            margin: 1em 0;
        }
        .toggle-button {
            padding: 0.5em 1em;
            border: none;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
        }
        .toggle-on {
            background-color: green;
            color: white;
        }
        .toggle-off {
            background-color: red;
            color: white;
        }
        .stats-container {
            display: flex;
            gap: 2em;
            margin-top: 1em;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        table th, table td {
            border: 1px solid #ddd;
            padding: 6px;
        }
        table th {
            background: #f4f4f4;
        }
        #domainChart {
            width: 400px;
            height: 400px;
        }
    </style>
</head>
<body>
    <h1>IMAP Bounce Processor Dashboard</h1>

    <p>Total Bounces: {{ bounce_count }}</p>

    {% if missing_vars %}
        <div style="color:red;">
            <strong>Missing environment variables:</strong> {{ ", ".join(missing_vars) }}
        </div>
    {% endif %}

    <div class="task-buttons">
        <button onclick="startTask('bounce')">▶ Run Bounce Check</button>
        <button onclick="startTask('retry')">▶ Run Retry Queue</button>
        <button id="testModeBtn" class="toggle-button">Test Mode</button>
        <button id="schedulerBtn" class="toggle-button">Scheduler</button>
    </div>

    <div class="stats-container">
        <div style="flex:2;">
            <h3>Recent Bounces</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Original To</th>
                        <th>Original Cc</th>
                        <th>Status</th>
                        <th>Reason</th>
                        <th>Domain</th>
                        <th>Notified To</th>
                        <th>Notified Cc</th>
                    </tr>
                </thead>
                <tbody id="bounceTableBody"></tbody>
            </table>
        </div>
        <div style="flex:1;">
            <h3>Top Domains</h3>
            <canvas id="domainChart"></canvas>
        </div>
    </div>

    <a href="/logout">Logout</a>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // -------- Task handling --------
        function startTask(task) {
            let url = task === 'bounce' ? '/run_bounce_check' : '/run_retry_queue';
            window.location.href = url;
        }

        // -------- Toggles --------
        async function updateToggles() {
            let res = await fetch("/get_toggles");
            let data = await res.json();

            let testBtn = document.getElementById("testModeBtn");
            testBtn.className = "toggle-button " + (data.test_mode ? "toggle-on" : "toggle-off");
            testBtn.innerText = "Test Mode: " + (data.test_mode ? "ON" : "OFF");

            let schedBtn = document.getElementById("schedulerBtn");
            schedBtn.className = "toggle-button " + (data.scheduler ? "toggle-on" : "toggle-off");
            schedBtn.innerText = "Scheduler: " + (data.scheduler ? "ENABLED" : "DISABLED");
        }

        document.getElementById("testModeBtn").onclick = async () => {
            await fetch("/toggle_test_mode", {method:"POST"});
            updateToggles();
        };
        document.getElementById("schedulerBtn").onclick = async () => {
            await fetch("/toggle_scheduler", {method:"POST"});
            updateToggles();
        };

        // -------- Stats table + chart --------
        async function loadStats() {
            let res = await fetch("/api/logs");
            let logs = await res.json();
            let tbody = document.getElementById("bounceTableBody");
            tbody.innerHTML = "";
            logs.data.slice(0,10).forEach(row => {
                let tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${row.email_to}</td>
                    <td>${row.email_cc}</td>
                    <td>${row.status}</td>
                    <td>${row.reason}</td>
                    <td>${row.domain}</td>
                    <td>${row.notified_to || ""}</td>
                    <td>${row.notified_cc || ""}</td>
                `;
                tbody.appendChild(tr);
            });

            let domRes = await fetch("/api/domain_stats");
            let domStats = await domRes.json();
            let ctx = document.getElementById("domainChart").getContext("2d");
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: domStats.data.map(r => r.domain),
                    datasets: [{
                        data: domStats.data.map(r => r.count),
                        backgroundColor: ['#0072CE','#DA291C','#54585A','#2ECC71','#F39C12']
                    }]
                }
            });
        }

        updateToggles();
        loadStats();
    </script>
</body>
</html>