<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>IMAP Bounce Processor - Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .task-buttons {
            margin: 1em 0;
        }
        .log-panel {
            display: none;
            border: 1px solid #ccc;
            background: #111;
            color: #0f0;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
            margin-top: 1em;
        }
    </style>
</head>
<body>
    <h1>IMAP Bounce Processor Dashboard</h1>

    <p>Total Bounces: {{ bounce_count }}</p>

    {% if missing_vars %}
        <div style="color:red;">
            <strong>Missing environment variables:</strong> {{ ", ".join(missing_vars) }}
        </div>
    {% endif %}

    <div class="task-buttons">
        <button onclick="startTask('bounce')">‚ñ∂ Run Bounce Check</button>
        <button onclick="startTask('retry')">‚ñ∂ Run Retry Queue</button>
        <button onclick="stopTask()">‚è∏ Stop Task</button>
        <button onclick="clearLog()">üßπ Clear Log</button>
    </div>

    <div id="logPanel" class="log-panel"></div>

    <a href="/logout">Logout</a>

    <script>
        let eventSource;

        function startTask(task) {
            stopTask(); // stop any running stream first
            clearLog();
            document.getElementById('logPanel').style.display = 'block';

            let url = task === 'bounce' ? '/run_bounce_check_stream' : '/run_retry_queue_stream';
            eventSource = new EventSource(url);

            eventSource.onmessage = function(event) {
                const panel = document.getElementById('logPanel');
                panel.textContent += event.data + "\n";
                panel.scrollTop = panel.scrollHeight;
            };

            eventSource.onerror = function() {
                stopTask();
            };
        }

        function stopTask() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                const panel = document.getElementById('logPanel');
                panel.textContent += "\n--- Task stopped ---\n";
                panel.scrollTop = panel.scrollHeight;
            }
        }

        function clearLog() {
            document.getElementById('logPanel').textContent = '';
        }
    </script>
</body>
</html>